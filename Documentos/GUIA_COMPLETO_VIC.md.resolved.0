# üìã GUIA COMPLETO: PROCESSO VIC

**Objetivo:** Documentar com riqueza de detalhes todo o processo realizado no sistema VIC/MAX, permitindo replica√ß√£o exata com chance zero de erro.

---

## üéØ VIS√ÉO GERAL

O Sistema VIC/MAX √© uma pipeline de processamento de dados financeiros que automatiza extra√ß√£o, tratamento e cruzamento de dados. O sistema utiliza um **fluxo h√≠brido v2.0** com 4 etapas principais:

```mermaid
flowchart LR
    E[1. EXTRA√á√ÉO] --> T[2. TRATAMENTO]
    T --> D[3. DEVOLU√á√ÉO]
    D --> B[4. BATIMENTO]
```

### Fluxo H√≠brido v2.0 ‚≠ê

O sistema usa duas varia√ß√µes da base VIC para diferentes prop√≥sitos:

| Varia√ß√£o | Descri√ß√£o | Uso |
|----------|-----------|-----|
| **VIC SEM AGING** | Base completa sem filtro de dias | Usado para **Devolu√ß√£o** (m√°ximo de registros) |
| **VIC COM AGING** | Base filtrada por >90 dias | Usado para **Batimento** (separa√ß√£o judicial precisa) |

---

## üìÇ ESTRUTURA DE ARQUIVOS

### Diret√≥rios de Entrada (`data/input/`)
```
data/input/
‚îú‚îÄ‚îÄ vic/                        # Dados VIC (Email/IMAP)
‚îÇ   ‚îî‚îÄ‚îÄ VicCandiotto.zip        # Base principal VIC
‚îú‚îÄ‚îÄ max/                        # Dados MAX (SQL Server)
‚îÇ   ‚îî‚îÄ‚îÄ MaxSmart.zip            # Base de cobran√ßa MAX
‚îú‚îÄ‚îÄ judicial/                   # Dados judiciais
‚îÇ   ‚îî‚îÄ‚îÄ ClientesJudiciais.zip   # CPFs em processo judicial
‚îî‚îÄ‚îÄ blacklist/                  # Clientes a excluir
    ‚îî‚îÄ‚îÄ blacklist.csv/xlsx      # Lista de CPFs bloqueados
```

### Diret√≥rios de Sa√≠da (`data/output/`)
```
data/output/
‚îú‚îÄ‚îÄ vic_tratada/                # Base VIC tratada
‚îÇ   ‚îî‚îÄ‚îÄ vic_base_limpa_YYYYMMDD_HHMMSS.zip
‚îú‚îÄ‚îÄ max/                        # Base MAX tratada
‚îÇ   ‚îî‚îÄ‚îÄ max_tratada_YYYYMMDD_HHMMSS.zip
‚îú‚îÄ‚îÄ inconsistencias/            # Registros inconsistentes
‚îÇ   ‚îú‚îÄ‚îÄ vic_inconsistencias_*.zip
‚îÇ   ‚îî‚îÄ‚îÄ max_inconsistencias_*.zip
‚îú‚îÄ‚îÄ devolucao/                  # Resultado da devolu√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ vic_devolucao_YYYYMMDD_HHMMSS.zip
‚îÇ       ‚îú‚îÄ‚îÄ vic_devolucao_jud_*.csv
‚îÇ       ‚îî‚îÄ‚îÄ vic_devolucao_extra_*.csv
‚îú‚îÄ‚îÄ batimento/                  # Resultado do batimento
‚îÇ   ‚îî‚îÄ‚îÄ vic_batimento_YYYYMMDD_HHMMSS.zip
‚îÇ       ‚îú‚îÄ‚îÄ vic_batimento_jud_*.csv
‚îÇ       ‚îî‚îÄ‚îÄ vic_batimento_extra_*.csv
‚îî‚îÄ‚îÄ enriquecimento/             # Contatos enriquecidos
    ‚îî‚îÄ‚îÄ enriquecimento_vic_*.zip
```

---

## üì• ETAPA 1: EXTRA√á√ÉO DE DADOS

### 1.1 Extra√ß√£o VIC (Email/IMAP)

**Arquivo:** `scripts/extrair_vic_email.py`  
**Comando:** `python main.py extract vic`

#### Fonte de Dados
| Item | Valor |
|------|-------|
| **Origem** | Email via IMAP (Gmail) |
| **Remetente** | `noreply@fcleal.com.br` |
| **Assunto** | Cont√©m "Candiotto" |
| **Anexo** | `candiotto.zip` |
| **Destino** | `data/input/vic/VicCandiotto.zip` |

#### Configura√ß√£o via [config.yaml](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Vic/config.yaml)
```yaml
email:
  imap_server: imap.gmail.com
  imap_folder: INBOX
  email_sender: noreply@fcleal.com.br
  email_subject_keyword: Candiotto
  attachment_filename: candiotto.zip
  output_filename: VicCandiotto.zip
  download_dir: data/input/vic
  validation:
    min_file_size_mb: 1.0  # Base v√°lida ~14MB, erro ~0.07MB
```

#### Valida√ß√£o de Tamanho
O sistema valida o tamanho do arquivo para detectar bases corrompidas:
- ‚úÖ **Base v√°lida:** ~14MB
- ‚ùå **Base com erro:** ~0.07MB (ser√° rejeitada)

---

### 1.2 Extra√ß√£o MAX (Banco SQL Server)

**Arquivo:** `scripts/extrair_max_sql.py`  
**Comando:** `python main.py extract max`

#### Fonte de Dados
| Item | Valor |
|------|-------|
| **Origem** | SQL Server (MaxSmart) |
| **Par√¢metro** | Via vari√°veis de ambiente |
| **Destino** | `data/input/max/MaxSmart.zip` |

#### Configura√ß√£o via [.env](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Emccamp/.env)
```properties
SQL_SERVER_HOST=servidor
SQL_SERVER_DATABASE=banco
SQL_SERVER_USER=usuario
SQL_SERVER_PASSWORD=senha
```

---

### 1.3 Extra√ß√£o de Dados Judiciais

**Comando:** `python main.py extract judicial`

| Item | Valor |
|------|-------|
| **Origem** | SQL Server |
| **Destino** | `data/input/judicial/ClientesJudiciais.zip` |

---

## üîß ETAPA 2: TRATAMENTO DE DADOS

### 2.1 Tratamento VIC

**Arquivo:** `src/processors/vic_processor.py`  
**Comando:** `python main.py treat vic`

#### Fluxo de Processamento

```mermaid
flowchart TD
    A[1. Carregar VicCandiotto.zip] --> B[2. Normalizar CPF/CNPJ]
    B --> C[3. Validar colunas obrigat√≥rias]
    C --> D[4. Exportar inconsist√™ncias]
    D --> E[5. Filtro STATUS = EM ABERTO]
    E --> F[6. Filtro TIPO_PARCELA]
    F --> G[7. Calcular AGING]
    G --> H[8. Filtro AGING por cliente]
    H --> I[9. Aplicar Blacklist]
    I --> J[10. Garantir chaves √∫nicas]
    J --> K[11. Exportar resultado]
```

#### 2.1.1 Normaliza√ß√£o de CPF/CNPJ
```python
# Transforma√ß√£o:
'123.456.789-01'     ‚Üí '12345678901'
'12.345.678/0001-90' ‚Üí '12345678000190'
```

#### 2.1.2 Campos Obrigat√≥rios

| Coluna | Tipo | Descri√ß√£o | Exemplo |
|--------|------|-----------|---------|
| `CHAVE` | String | ID √∫nico (contrato-parcela) | `12345-001` |
| `CPF_CNPJ` | String | Documento do cliente | `12345678901` |
| `NOME_CLIENTE` | String | Nome/Raz√£o social | `Jo√£o Silva` |
| `STATUS_TITULO` | String | Status da parcela | `EM ABERTO` |
| `TIPO_PARCELA` | String | Tipo da parcela | `PROSOLUTO` |
| `VENCIMENTO` | Date | Data de vencimento | `2024-01-15` |
| `VALOR_PARCELA` | Float | Valor da parcela | `1500.00` |

#### 2.1.3 Filtro de Status

**Regra:** Mant√©m apenas parcelas com `STATUS_TITULO = 'EM ABERTO'`

```python
# Configura√ß√£o (config.yaml):
vic_processor:
  status_em_aberto: "EM ABERTO"
```

#### 2.1.4 Filtro de Tipo de Parcela

**Tipos aceitos:**
- `PROSOLUTO`
- `ITBI`
- `EVOLUCAO DE OBRA`

```yaml
vic_processor:
  tipos_validos: ["PROSOLUTO", "ITBI", "EVOLUCAO DE OBRA"]
```

#### 2.1.5 C√°lculo de Aging

```python
# F√≥rmula:
AGING_DIAS = (data_atual - DATA_VENCIMENTO).days

# Regras:
# - Datas futuras: aging = 0
# - Datas inv√°lidas: removidas
```

#### 2.1.6 Filtro de Aging por Cliente ‚≠ê IMPORTANTE

**L√≥gica:**
1. Agrupa por `CPF_CNPJ`
2. Verifica se cliente tem [max(AGING_DIAS) > 90](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Emccamp/src/processors/batimento.py#140-153)
3. Se SIM ‚Üí mant√©m **TODAS** as parcelas do cliente
4. Se N√ÉO ‚Üí remove **TODAS** as parcelas do cliente

```yaml
vic_processor:
  aging_minimo: 90  # dias
```

> **Nota:** Este filtro pode ser habilitado/desabilitado para gerar varia√ß√µes da base VIC.

#### 2.1.7 Aplica√ß√£o de Blacklist

**Processo:**
1. Carrega arquivos de `data/input/blacklist/` (CSV ou Excel)
2. Detecta automaticamente colunas com CPF/CNPJ
3. Normaliza documentos (remove caracteres especiais)
4. Remove registros cujo CPF est√° na blacklist

```yaml
vic_processor:
  filtros_inclusao:
    blacklist: true
```

#### 2.1.8 Valida√ß√£o de Chaves √önicas

**Estrat√©gia para duplicatas:**
1. Ordena por `AGING_DIAS` (maior primeiro)
2. Mant√©m apenas o primeiro registro de cada `CHAVE`
3. Exporta duplicatas removidas para auditoria

#### 2.1.9 Arquivos de Sa√≠da

| Arquivo | Conte√∫do |
|---------|----------|
| `vic_base_limpa_YYYYMMDD_HHMMSS.zip` | Registros v√°lidos |
| `vic_inconsistencias_YYYYMMDD_HHMMSS.zip` | Registros com problemas |

---

### 2.2 Tratamento MAX

**Arquivo:** `src/processors/max_processor.py`  
**Comando:** `python main.py treat max`

#### 2.2.1 Valida√ß√£o de PARCELA

**Regex de Valida√ß√£o:**
```regex
^[A-Za-z0-9]+(?:-[A-Za-z0-9]+)+$
```

**Exemplos:**
| Valor | V√°lido? |
|-------|---------|
| `12345-01` | ‚úÖ |
| `ABC-123` | ‚úÖ |
| `12345` | ‚ùå (falta h√≠fen) |

#### 2.2.2 Campos Obrigat√≥rios

```yaml
max_processor:
  columns:
    required: ["CPFCNPJ_CLIENTE", "NUMERO_CONTRATO", "PARCELA", "VENCIMENTO", "VALOR"]
```

#### 2.2.3 Filtros

```yaml
max_processor:
  status_em_aberto: "Aberto"
  validation:
    remover_parcela_duplicada: true
```

#### 2.2.4 Arquivos de Sa√≠da

| Arquivo | Conte√∫do |
|---------|----------|
| `max_tratada_YYYYMMDD_HHMMSS.zip` | Registros v√°lidos |
| `max_inconsistencias_YYYYMMDD_HHMMSS.zip` | Registros com problemas |

---

## üîÅ ETAPA 3: DEVOLU√á√ÉO MAX ‚àí VIC

**Arquivo:** `src/processors/devolucao_processor.py`  
**Comando:** `python main.py devolucao`

### Objetivo
Identificar registros presentes na base MAX mas **AUSENTES** na base VIC para devolu√ß√£o.

> **F√≥rmula:** `MAX - VIC` (Anti-Join)

### Fluxo de Processamento

```mermaid
flowchart TD
    A[1. Carregar max_tratada] --> B[2. Carregar vic_tratada SEM AGING]
    B --> C[3. Filtrar MAX por STATUS]
    C --> D[4. Anti-Join: MAX - VIC]
    D --> E[5. Carregar CPFs judiciais]
    E --> F[6. Classificar judicial/extrajudicial]
    F --> G[7. Formatar layout de sa√≠da]
    G --> H[8. Exportar ZIP]
```

### 3.1 Configura√ß√£o

```yaml
devolucao:
  campanha_termo: ""           # Filtro de campanha (vazio = todas)
  status_excluir: []           # Status a excluir
  
  chaves:
    vic: "CHAVE"               # Campo chave do VIC
    max: "PARCELA"             # Campo chave do MAX
  
  filtros_max:
    status_em_aberto: true     # Filtrar apenas status aberto
  
  export:
    filename_prefix: "vic_devolucao"
    subdir: "devolucao"
  
  status_devolucao_fixo: "98"  # Status fixo para devolu√ß√£o
```

### 3.2 Opera√ß√£o Anti-Join

```python
# Retorna registros MAX que N√ÉO existem em VIC
def procv_max_menos_vic(df_max, df_vic, col_max="PARCELA", col_vic="CHAVE"):
    right_keys = set(df_vic[col_vic].astype(str).str.strip().dropna())
    mask = ~df_max[col_max].astype(str).str.strip().isin(right_keys)
    return df_max[mask].copy()
```

### 3.3 Classifica√ß√£o Judicial/Extrajudicial

1. Carrega arquivo `ClientesJudiciais.zip`
2. Extrai conjunto de CPFs normalizados
3. Para cada registro da devolu√ß√£o:
   - Se CPF est√° na lista judicial ‚Üí **Judicial**
   - Se CPF n√£o est√° na lista ‚Üí **Extrajudicial**

### 3.4 Layout de Sa√≠da

| Coluna | Descri√ß√£o |
|--------|-----------|
| `CNPJ CREDOR` | CNPJ fixo: `12.086.678/0001-18` |
| `CPFCNPJ CLIENTE` | CPF/CNPJ do cliente |
| `NOME / RAZAO SOCIAL` | Nome do cliente |
| `PARCELA` | Chave da parcela |
| `VENCIMENTO` | Data de vencimento |
| `VALOR` | Valor da parcela |
| `TIPO PARCELA` | Tipo da parcela |
| `DATA DEVOLUCAO` | Data atual |
| `STATUS` | Valor fixo: `98` |

### 3.5 Arquivos de Sa√≠da

```
vic_devolucao_YYYYMMDD_HHMMSS.zip
‚îú‚îÄ‚îÄ vic_devolucao_jud_*.csv       (judicial)
‚îî‚îÄ‚îÄ vic_devolucao_extra_*.csv     (extrajudicial)
```

---

## ‚öñÔ∏è ETAPA 4: BATIMENTO VIC ‚àí MAX

**Arquivo:** `src/processors/batimento_processor.py`  
**Comando:** `python main.py batimento`

### Objetivo
Identificar registros presentes na base VIC mas **AUSENTES** na base MAX.

> **F√≥rmula:** `VIC - MAX` (Anti-Join)

### Fluxo de Processamento

```mermaid
flowchart TD
    A[1. Carregar vic_tratada COM AGING] --> B[2. Carregar max_tratada]
    B --> C[3. Anti-Join: VIC - MAX]
    C --> D[4. Carregar CPFs judiciais]
    D --> E[5. Classificar judicial/extrajudicial]
    E --> F[6. Formatar layout de sa√≠da]
    F --> G[7. Exportar ZIP]
```

### 4.1 Diferen√ßa do Batimento

O batimento usa **VIC COM AGING** (filtrado >90 dias) para:
- Garantir separa√ß√£o judicial precisa
- Focar em parcelas realmente em atraso

### 4.2 Configura√ß√£o

```yaml
batimento_processor:
  export:
    filename_prefix: "vic_batimento"
```

### 4.3 Arquivos de Sa√≠da

```
vic_batimento_YYYYMMDD_HHMMSS.zip
‚îú‚îÄ‚îÄ vic_batimento_jud_*.csv       (judicial)
‚îî‚îÄ‚îÄ vic_batimento_extra_*.csv     (extrajudicial)
```

---

## ‚öôÔ∏è CONFIGURA√á√ïES GLOBAIS

### Arquivo: [config.yaml](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Vic/config.yaml)

```yaml
global:
  date_format: "%d/%m/%Y"
  encoding: "utf-8-sig"
  empresa:
    cnpj: "12.086.678/0001-18"

vic_processor:
  status_em_aberto: "EM ABERTO"
  status_baixa: "BAIXADO"
  tipos_validos: ["PROSOLUTO", "ITBI", "EVOLUCAO DE OBRA"]
  aging_minimo: 90
  filtros_inclusao:
    status_em_aberto: true
    tipos_validos: true
    aging: true
    blacklist: true
  phone_columns:
    - "TEL. RESIDENCIAL"
    - "TEL. COMERCIAL"
    - "TEL. CELULAR"

max_processor:
  status_em_aberto: "Aberto"
  columns:
    required: ["CPFCNPJ_CLIENTE", "NUMERO_CONTRATO", "PARCELA", "VENCIMENTO", "VALOR"]
  validation:
    chave_regex: "^[A-Za-z0-9]+(?:-[A-Za-z0-9]+)+$"
    remover_parcela_duplicada: true
```

### Vari√°veis de Ambiente ([.env](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Emccamp/.env))

```properties
# Email (IMAP)
EMAIL=seu_email@gmail.com
EMAIL_PASSWORD=senha_app
IMAP_SERVER=imap.gmail.com

# SQL Server
SQL_SERVER_HOST=servidor
SQL_SERVER_DATABASE=banco
SQL_SERVER_USER=usuario
SQL_SERVER_PASSWORD=senha
```

---

## üöÄ COMANDOS DE EXECU√á√ÉO

### Execu√ß√£o Individual

```bash
# Extra√ß√£o de dados
python main.py extract vic           # Extrai base VIC (email)
python main.py extract max           # Extrai base MAX (SQL)
python main.py extract judicial      # Extrai clientes judiciais

# Tratamento de dados
python main.py treat vic             # Trata base VIC
python main.py treat max             # Trata base MAX
python main.py treat all             # Trata ambas as bases

# Processamentos
python main.py devolucao             # Executa devolu√ß√£o
python main.py batimento             # Executa batimento
python main.py enriquecimento        # Executa enriquecimento
```

### Execu√ß√£o Completa via Scripts .bat

**`run_completo2.0.bat` ‚≠ê RECOMENDADO:**
```
1. Verifica Python instalado
2. Prepara ambiente virtual (venv)
3. Instala depend√™ncias
4. Extrai VIC, MAX, Judicial
5. Trata VIC SEM AGING ‚Üí Devolu√ß√£o
6. Trata VIC COM AGING ‚Üí Batimento
7. Grava logs em data/logs/execucao_completa_v2.log
```

**[run_pipeline.bat](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Vic/run_pipeline.bat):**
Menu interativo com op√ß√µes:
1. Pipeline Padr√£o (v1.0)
2. Pipeline H√≠brido (v2.0) ‚≠ê
3. Pipeline Sem Aging
4. Processadores individuais
5. Extra√ß√£o autom√°tica

---

## üìä COMPARA√á√ÉO: FLUXO v1.0 vs v2.0

| Aspecto | v1.0 | v2.0 (H√≠brido) | Melhoria |
|---------|------|----------------|----------|
| **Registros Devolu√ß√£o** | 163k | 470k | +188% |
| **Precis√£o Batimento** | ‚úÖ | ‚úÖ | Mantida |
| **Separa√ß√£o Judicial** | ‚úÖ | ‚úÖ | Mantida |
| **Estrat√©gia** | √önica base VIC | VIC SEM/COM aging | Otimizada |

---

## üìä RESUMO DAS BASES CRUZADAS

| Etapa | Base Principal | Base de Cruzamento | Opera√ß√£o | Resultado |
|-------|----------------|-------------------|----------|-----------|
| **Devolu√ß√£o** | MAX tratada | VIC tratada SEM AGING | MAX ‚àí VIC | T√≠tulos para devolu√ß√£o |
| **Batimento** | VIC tratada COM AGING | MAX tratada | VIC ‚àí MAX | T√≠tulos ausentes em MAX |

---

## üìÇ M√âTRICAS T√çPICAS

### Volumes de Processamento (v2.0)

| Etapa | Entrada | Sa√≠da | Taxa |
|-------|---------|-------|------|
| **VIC SEM AGING** | 921,560 | 470,709 | 51.1% |
| **VIC COM AGING** | 921,560 | 163,122 | 17.7% |
| **MAX Tratado** | 195,459 | 190,884 | 97.7% |
| **Devolu√ß√£o** | - | 1,979 | 1.63% |
| **Batimento** | - | 4,030 | 2.47% |

### Performance

- ‚è±Ô∏è **Tempo m√©dio:** 3-5 minutos (com extra√ß√£o)
- üíæ **Uso de mem√≥ria:** ~2GB
- üìÅ **Espa√ßo em disco:** ~500MB por execu√ß√£o

---

## ‚úÖ CHECKLIST DE REPLICA√á√ÉO

- [ ] Configurar vari√°veis de ambiente ([.env](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Emccamp/.env))
- [ ] Configurar [config.yaml](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Vic/config.yaml) conforme necess√°rio
- [ ] Executar diagn√≥stico: `diagnosticar_ambiente.bat`
- [ ] Executar setup: [setup_project.bat](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Vic/setup_project.bat)
- [ ] Executar extra√ß√µes: VIC ‚Üí MAX ‚Üí Judicial
- [ ] Verificar arquivos em `data/input/`
- [ ] Executar `run_completo2.0.bat` (recomendado)
- [ ] Verificar `data/output/devolucao/` e `data/output/batimento/`
- [ ] Conferir logs em `data/logs/`

---

*Documenta√ß√£o gerada em: 25/12/2025*  
*Projeto: VIC/MAX - Sistema de Processamento de Dados Financeiros v2.0*
