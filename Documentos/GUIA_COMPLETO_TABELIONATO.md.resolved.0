# üìã GUIA COMPLETO: PROCESSO TABELIONATO

**Objetivo:** Documentar com riqueza de detalhes todo o processo realizado no sistema Tabelionato, permitindo replica√ß√£o exata com chance zero de erro.

> ‚ö†Ô∏è **IMPORTANTE:** Esta documenta√ß√£o foi validada diretamente no c√≥digo-fonte em 25/12/2025.

---

## üéØ VIS√ÉO GERAL

O Sistema Tabelionato √© uma pipeline de processamento de dados de protestos que automatiza extra√ß√£o, tratamento e cruzamento de dados. O sistema possui **4 etapas principais**:

```mermaid
flowchart LR
    E[1. EXTRA√á√ÉO] --> T[2. TRATAMENTO]
    T --> M[3. TRATAMENTO MAX]
    M --> B[4. BATIMENTO]
```

| Etapa | Objetivo | Resultado |
|-------|----------|-----------|
| 1. Extra√ß√£o | Coletar dados de email e SQL | Arquivos ZIP em `data/input/` |
| 2. Tratamento | Normalizar, validar e classificar | `tabelionato_tratado.zip` |
| 3. Tratamento MAX | Processar base MAX | `max_tratada.zip` |
| 4. Batimento | Identificar protocolos ausentes no MAX | Arquivos por campanha (58, 78, 94) |

---

## üìÇ ESTRUTURA DE ARQUIVOS

### Diret√≥rios de Entrada (`data/input/`)
```
data/input/
‚îú‚îÄ‚îÄ tabelionato/                # Dados Tabelionato (Email)
‚îÇ   ‚îî‚îÄ‚îÄ Tabelionato.zip         # Base principal (ZIP protegido)
‚îú‚îÄ‚îÄ max/                        # Dados MAX (SQL Server)
‚îÇ   ‚îî‚îÄ‚îÄ MaxSmart.zip            # Base de cobran√ßa MAX
‚îî‚îÄ‚îÄ judicial/                   # (Opcional) Clientes judiciais
```

### Diret√≥rios de Sa√≠da (`data/output/`)
```
data/output/
‚îú‚îÄ‚îÄ tabelionato_tratada/        # Base Tabelionato tratada
‚îÇ   ‚îî‚îÄ‚îÄ tabelionato_tratado.zip
‚îú‚îÄ‚îÄ max_tratada/                # Base MAX tratada
‚îÇ   ‚îî‚îÄ‚îÄ max_tratada.zip
‚îú‚îÄ‚îÄ inconsistencias/            # Registros inconsistentes
‚îÇ   ‚îî‚îÄ‚îÄ tabelionato_inconsistencias.zip
‚îú‚îÄ‚îÄ batimento/                  # Resultado do batimento por campanha
‚îÇ   ‚îú‚îÄ‚îÄ batimento_campanha58.zip
‚îÇ   ‚îú‚îÄ‚îÄ batimento_campanha78.zip
‚îÇ   ‚îî‚îÄ‚îÄ batimento_campanha94.zip
‚îî‚îÄ‚îÄ enriquecimento/             # Tabela de enriquecimento
    ‚îî‚îÄ‚îÄ tabela_enriquecimento.zip
```

---

## üì• ETAPA 1: EXTRA√á√ÉO DE DADOS

### 1.1 Extra√ß√£o Tabelionato (Email/IMAP)

**Arquivo:** [src/extrair_base_tabelionato.py](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/src/extrair_base_tabelionato.py)  
**Comando:** Via [fluxo_completo.bat](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/fluxo_completo.bat)

#### Fonte de Dados
| Item | Valor |
|------|-------|
| **Origem** | Email via IMAP (Gmail) |
| **Remetente** | `adriano@4protestobh.com` |
| **Assunto** | Cont√©m "Base de Dados" |
| **Anexo** | ZIP com dados de protesto |
| **Senha ZIP** | `Mf4tab@` |
| **Destino** | `data/input/tabelionato/Tabelionato.zip` |

---

### 1.2 Extra√ß√£o MAX (Banco SQL Server)

**Arquivo:** [src/extracao_base_max_tabelionato.py](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/src/extracao_base_max_tabelionato.py)  
**Comando:** Via [fluxo_completo.bat](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/fluxo_completo.bat)

| Item | Valor |
|------|-------|
| **Origem** | SQL Server (MaxSmart) |
| **Destino** | `data/input/max/MaxSmart.zip` |

---

## üîß ETAPA 2: TRATAMENTO TABELIONATO

**Arquivo:** [src/tratamento_tabelionato.py](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/src/tratamento_tabelionato.py)  
**Classe:** [TabelionatoProcessor](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/src/tratamento_tabelionato.py#24-547)

### Fluxo de Processamento

```mermaid
flowchart TD
    A[1. Carregar ZIP protegido] --> B[2. Normalizar cabe√ßalhos]
    B --> C[3. Normalizar DtAnuencia]
    C --> D[4. Calcular AGING]
    D --> E[5. Formatar CPF/CNPJ]
    E --> F[6. Criar CHAVE a partir de Protocolo]
    F --> G[7. Atribuir Campanha por aging]
    G --> H[8. Validar dados]
    H --> I[9. Exportar inconsist√™ncias]
    I --> J[10. Exportar resultado tratado]
```

### 2.1 Carregamento (ZIP Protegido)

```python
# Senha do ZIP:
self.zip_password = b"Mf4tab@"
```

> O arquivo ZIP chega protegido por senha. O sistema descompacta automaticamente.

### 2.2 Normaliza√ß√£o de DtAnuencia

```python
# Convers√£o para datetime, removendo componente de hora:
dt_anuencia = pd.to_datetime(df['DtAnuencia'], errors='coerce', dayfirst=True)
dt_anuencia = dt_anuencia.dt.normalize()
df['DtAnuencia'] = dt_anuencia
```

### 2.3 C√°lculo de AGING ‚≠ê IMPORTANTE

```python
# F√≥rmula:
AGING = (data_referencia - DtAnuencia).days

# Data de refer√™ncia: hoje (se n√£o configurada)
referencia = pd.Timestamp.now().normalize()

# Aging negativo √© normalizado para 0
aging = aging.where(aging >= 0, 0)
```

**Tipo de dado:** `Int64` (nullable integer)

### 2.4 Formata√ß√£o CPF/CNPJ

```python
# Remove espa√ßos e reaaplica m√°scara:
# CPF: 123.456.789-01
# CNPJ: 12.345.678/0001-90
```

### 2.5 Cria√ß√£o de CHAVE

```python
# CHAVE = Protocolo (string)
df['CHAVE'] = df['Protocolo'].astype(str).str.strip()
```

> A coluna `CHAVE` √© criada diretamente a partir do campo `Protocolo`.

### 2.6 Atribui√ß√£o de Campanha ‚≠ê REGRA CR√çTICA

| Condi√ß√£o | Campanha |
|----------|----------|
| AGING ‚â§ 1800 dias | **Campanha 58** |
| AGING > 1800 dias | **Campanha 94** |
| Protocolos com aging misto | **Campanha 58** (prioridade) |

**Regra especial de aging misto:**
```python
# Se um protocolo possui registros TANTO ‚â§1800 QUANTO >1800:
# ‚Üí TODOS os registros desse protocolo v√£o para Campanha 58
```

### 2.7 Valida√ß√£o de Dados

**Inconsist√™ncias detectadas:**
1. ‚ùå `DtAnuencia` vazia ou nula
2. ‚ùå `DtAnuencia` com formato inv√°lido
3. ‚ùå `DtAnuencia` anterior a 1900
4. ‚ùå Campos textuais com quebras de linha (`\r\n`)

**Campos obrigat√≥rios impl√≠citos:**
- `Protocolo` (para criar CHAVE)
- `DtAnuencia` (para calcular AGING)

### 2.8 Arquivos de Sa√≠da

| Arquivo | Conte√∫do |
|---------|----------|
| `tabelionato_tratado.zip` | Registros v√°lidos com Campanha |
| `tabelionato_inconsistencias.zip` | Registros com problemas + Motivo |

---

## üîß ETAPA 3: TRATAMENTO MAX

**Arquivo:** [src/tratamento_max.py](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/src/tratamento_max.py)

### 3.1 Valida√ß√£o

- Coluna `CHAVE` obrigat√≥ria (a partir de `PARCELA`)
- Filtro por `STATUS_TITULO` = "EM ABERTO" (opcional)

### 3.2 Arquivo de Sa√≠da

| Arquivo | Conte√∫do |
|---------|----------|
| `max_tratada.zip` | Registros v√°lidos |

---

## ‚öñÔ∏è ETAPA 4: BATIMENTO TABELIONATO √ó MAX

**Arquivo:** [src/batimento_tabelionato.py](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/src/batimento_tabelionato.py)  
**Classe:** [TabelionatoBatimento](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/src/batimento_tabelionato.py#34-635)

### Objetivo
Identificar protocolos presentes no Tabelionato tratado que **N√ÉO EXISTEM** na base MAX.

> **F√≥rmula:** `TABELIONATO - MAX` (Anti-Join por CHAVE)

### Fluxo de Processamento

```mermaid
flowchart TD
    A[1. Carregar Tabelionato tratado] --> B[2. Carregar MAX tratado]
    B --> C[3. Carregar MAX bruto para regra campanha 78]
    C --> D[4. Anti-Join: TABELIONATO - MAX]
    D --> E[5. Redistribuir para Campanha 78]
    E --> F[6. Aplicar regra de prioriza√ß√£o CNPJ/CPF]
    F --> G[7. Formatar layout de sa√≠da]
    G --> H[8. Gerar arquivos por campanha]
```

### 4.1 Opera√ß√£o Anti-Join

```python
def _procv_tabelionato_menos_max(df_tabelionato, df_max):
    """Anti-join: protocolos do Tabelionato N√ÉO presentes no MAX."""
    max_keys = set(df_max['CHAVE'].astype(str).str.strip().dropna())
    mask = ~df_tabelionato['CHAVE'].astype(str).str.strip().isin(max_keys)
    return df_tabelionato.loc[mask].copy()
```

### 4.2 Regra Campanha 78 ‚≠ê IMPORTANTE

**L√≥gica:**
1. Carrega base MAX bruta (antes do tratamento)
2. Filtra registros da **Campanha 78** com **status EM ABERTO**
3. Extrai CPFs/CNPJs desses registros
4. Se um registro pendente tem CPF/CNPJ que est√° em aberto na Campanha 78 do MAX ‚Üí **realoca para Campanha 78**

```python
# Filtros para identificar documentos da Campanha 78:
mask_campanha = campanha.str.contains('78', regex=False)
mask_status = status.isin({'aberto', 'em aberto', 'a', '0'})
mask_final = mask_doc & mask_campanha & mask_status
```

### 4.3 Regra de Prioriza√ß√£o CNPJ/CPF ‚≠ê IMPORTANTE

Para protocolos com **m√∫ltiplos registros** (CPF e CNPJ):

| Prioridade | Tipo | Tamanho |
|------------|------|---------|
| 0 (maior) | CNPJ | 18 caracteres |
| 1 | CPF | 14 caracteres |
| 2 (menor) | Outros | demais |

**Resultado:**
- **Registro principal:** primeiro ap√≥s ordena√ß√£o por prioridade
- **Demais registros:** v√£o para tabela de **enriquecimento**

```python
# Ordena√ß√£o:
colunas = ['CHAVE', 'PRIORIDADE_DOCUMENTO', 'DtAnuencia']
ordem = [True, True, False]  # DtAnuencia mais recente primeiro
```

### 4.4 Layout de Sa√≠da

| Coluna | Origem |
|--------|--------|
| `Campanha` | Calculada (58, 78, 94) |
| `CPFCNPJ CLIENTE` | `CpfCnpj` |
| `NOME / RAZAO SOCIAL` | `Devedor` |
| `VALOR` | `Custas` (formatado moeda) |
| `ID NEGOCIADOR` | Vazio |
| `CNPJ CREDOR` | Fixo: `16.746.133/0001-41` |
| `PARCELA` | `Protocolo` |
| `VENCIMENTO` | `DtAnuencia` |
| `OBSERVACAO CONTRATO` | `Credor` |
| `NUMERO CONTRATO` | `Protocolo` |

### 4.5 Arquivos de Sa√≠da

```
data/output/batimento/
‚îú‚îÄ‚îÄ batimento_campanha58.zip    # Protocolos com aging ‚â§ 1800 dias
‚îú‚îÄ‚îÄ batimento_campanha78.zip    # Protocolos com CPF em aberto na MAX campanha 78
‚îî‚îÄ‚îÄ batimento_campanha94.zip    # Protocolos com aging > 1800 dias

data/output/enriquecimento/
‚îî‚îÄ‚îÄ tabela_enriquecimento.zip   # Registros duplicados por protocolo
```

---

## ‚öôÔ∏è CONFIGURA√á√ïES

### Par√¢metros Globais

```python
# Codifica√ß√£o e separadores:
self.encoding = 'utf-8'
self.csv_separator = ';'

# Senha do ZIP de entrada:
self.zip_password = b"Mf4tab@"

# Limite de aging para campanhas:
# ‚â§ 1800 dias ‚Üí Campanha 58
# > 1800 dias ‚Üí Campanha 94

# CNPJ do credor (fixo nas sa√≠das):
CNPJ_CREDOR = '16.746.133/0001-41'
```

### Vari√°veis de Ambiente

```properties
# Email (IMAP)
EMAIL_USER=seu_email@gmail.com
EMAIL_PASSWORD=senha_app

# SQL Server
DB_HOST=servidor
DB_DATABASE=banco
DB_USER=usuario
DB_PASSWORD=senha

# Formata√ß√£o de valores
CSV_DECIMAL_SEPARATOR=,
```

---

## üöÄ COMANDOS DE EXECU√á√ÉO

### Execu√ß√£o Completa

```bash
# Via script batch (recomendado):
fluxo_completo.bat
```

### Menu Interativo

```bash
run_tabelionato.bat
```

**Op√ß√µes do menu:**
1. Preparar ambiente
2. Extra√ß√£o Tabelionato
3. Extra√ß√£o MAX
4. Tratamento Tabelionato
5. Tratamento MAX
6. Batimento
7. Fluxo completo

---

## üìä RESUMO DAS REGRAS DE CAMPANHA

| Campanha | Crit√©rio | Prioridade |
|----------|----------|------------|
| **58** | AGING ‚â§ 1800 dias | Principal (inclui aging misto) |
| **78** | CPF/CNPJ em aberto na MAX campanha 78 | Realoca√ß√£o |
| **94** | AGING > 1800 dias | Secund√°ria |

---

## üìä M√âTRICAS T√çPICAS

| Etapa | Entrada | Sa√≠da | Taxa |
|-------|---------|-------|------|
| Tabelionato tratado | ~50K | ~48K | ~96% |
| MAX tratado | ~200K | ~190K | ~95% |
| Batimento | - | ~5K | ~10% |

---

## ‚úÖ CHECKLIST DE REPLICA√á√ÉO

- [ ] Configurar vari√°veis de ambiente ([.env](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Emccamp/.env))
- [ ] Executar [run_tabelionato.bat](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/run_tabelionato.bat) op√ß√£o 1 (preparar ambiente)
- [ ] Verificar arquivo [Tabelionato.zip](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato.zip) em `data/input/tabelionato/`
- [ ] Verificar arquivo MAX em `data/input/max/`
- [ ] Executar [fluxo_completo.bat](file:///c:/Users/Thiago/Desktop/Versoes%20projetos%20Bases/Automacao_Tabelionato/fluxo_completo.bat)
- [ ] Verificar `data/output/tabelionato_tratada/`
- [ ] Verificar `data/output/max_tratada/`
- [ ] Verificar `data/output/batimento/`
- [ ] Conferir arquivos por campanha (58, 78, 94)
- [ ] Conferir tabela de enriquecimento

---

*Documenta√ß√£o gerada em: 25/12/2025*  
*Projeto: Tabelionato - Sistema de Processamento de Dados de Protestos*
